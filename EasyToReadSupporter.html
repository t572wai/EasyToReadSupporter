<!DOCTYPE html>
<html lang="jp" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>読書サポーター</title>
		<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/redmond/jquery-ui.css">
		<script type="text/javascript">
			let text = new Array();
			// let scroll = 500;

			$(function () {
				$('.Dialog').dialog({
					autoOpen: false
				});
				$('#textDialog').dialog({
					title:"テキスト設定",
					buttons:[
						{
							text: "決定",
							click: function () {
								console.log($('#settingText').val());
								text = $('#settingText').val().split('\n');
								while (text.length<5) {
									text.push(" ");
								}
								let i=0;
								for (char of text) {
									if(char=="")text[i]="&emsp;";
									i++;
								}
								let TText = new Array();
								for (char of text) {
									Array.prototype.push.apply(TText,splitByLength(char.split(/(?<=。|、|!|\?)(?!」|\)|>|}|]|\r\n)|(?<=!)(?!\?)|(?<=\?)(?!!)/),20));
									// Array.prototype.push.apply(TText,char.split(/(?<=。|、|!|\?)(?!」)/));
								}
								text = JSON.parse(JSON.stringify(TText));
								updateText(0);
							}
						}
					]
				});
			}
		);
			function OpenTextDialog() {
				$('#textDialog').dialog('open');
			}

			function updateText(i) {
				if(i=="")i=0;
				// console.log(i);
				if(i>=text.length-5)i=text.length-5;
				let displayText = '<span class="1or5line">'+text[i+0]+'</span><br>'+
													'<span class="2or4line">'+text[i+1]+'</span><br>'+
													'<span class="3line">'+text[i+2]+'</span><br>'+
													'<span class="2or4line">'+text[i+3]+'</span><br>'+
													'<span class="1or5line">'+text[i+4]+'</span>';
				$('#textDisplay').html(displayText);
				updateCSS();
			}
			let divFlg = false;
			let i=0;
			let intID;
			function startScroll() {
				divFlg = !divFlg;
				if (divFlg) {
					scroll=parseInt($('#speedInput').val());
					$('#scrollButton').text("停止");
					updateText(++i);
					// console.log(scroll);
					intID = setInterval(function () {
						updateText(++i);
					},scroll);
				}else {
					$('#scrollButton').text("開始");
					clearInterval(intID);
				}
			}
			function updateCSS() {
				$('.1or5line').css({'color':'lightgray','background-color':'black'});
				$('.2or4line').css({'color':'gray','background-color':'lightgray'});
				$('.3line,.2or4line,.1or5line').css({'width':'400px','display':'inline-block'});
			}
			function loadText() {
				$('#loadName').val()
			}
			function saveText() {
				sendData($('#settingText').val(),$('#saveName').val());
			}
			function splitByLength(array, length) {
				let resultArrAll = [];
				for (str of array) {
					// console.log(str);
					var resultArr = [];
					if (length && length >= 1) {
						var index = 0;
						var start = index;
						var end = start + length;
						while (start < str.length) {
							resultArr[index] = str.substring(start, end);
							index++;
							start = end;
							end = start + length;
						}
						Array.prototype.push.apply(resultArrAll,resultArr);
						// resultArrAll.push(resultArr);
					}
				}
				// console.log(resultArrAll);
				return resultArrAll;
			}
			function sendData(data,filename) {
					var XHR = new XMLHttpRequest();
					var urlEncodedData = "";
					var urlEncodedDataPairs = [];
					var name;

					// data オブジェクトを、URL エンコードしたキーと値のペアの配列に変換します
					for(name in data) {
						urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
					}

					// キーと値のペアをひとつの文字列に連結して、Web ブラウザのフォーム送信方式に
					// 合うよう、エンコードされた空白をプラス記号に置き換えます。
					urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

					// データが正常に送信された場合に行うことを定義します
					XHR.addEventListener('load', function(event) {
						alert('Yeah! Data sent and response loaded.');
					});

					// エラーが発生した場合に行うことを定義します
					XHR.addEventListener('error', function(event) {
						alert('Oups! Something goes wrong.');
					});

					// リクエストをセットアップします
					XHR.open('POST', 'https://t572wai.github.io/EasyToReadSupporter/data');

					// フォームデータの POST リクエストを扱うために必要な HTTP ヘッダを追加します
					XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

					// 最後に、データを送信します
			XHR.send(urlEncodedData);
		}
		</script>
		<style>
			.Dialog{
				display: none;
			}
		</style>
	</head>
	<body src="scroll.js" id="hello">
		<h1>読書サポーター</h1>
		<button type="button" name="button" onclick="OpenTextDialog()">文章設定</button>
		<div class="Dialog" id="textDialog">
			テキスト設定<br>
			<input type="text" value="ID" id="loadName"><button onclick="loadText();">読み込み</button><br>
			<input type="text" value="ID" id="saveName"><button onclick="saveText();">読み込み</button>
			<textarea id="settingText" rows="8" cols="80"></textarea>
		</div>
		<button type="button" name="button" onclick="startScroll()" id="scrollButton">開始</button>
		<input type="range" id="speedInput" value="500" step="1" min="200" max="1500" oninput="$('#speed').text(this.value);">
		&ensp;速度:
		<span id="speed">500</span>
		<!-- <button type="button" name="button" onclick="stopScroll()">停止</button> -->
		<div id="textDisplay"></div>
	</body>
</html>
